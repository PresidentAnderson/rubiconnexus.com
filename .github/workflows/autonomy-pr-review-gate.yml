name: Autonomy PR Review Gate

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches: ["main", "master"]

permissions:
  contents: read
  issues: read
  pull-requests: write

jobs:
  review-gate:
    if: startsWith(github.head_ref, 'agent/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate agent PR
        run: |
          echo "üîç Validating autonomous agent PR..."
          
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          BRANCH_NAME="${{ github.head_ref }}"
          
          # Validation checks
          ERRORS=()
          
          # Check branch naming convention
          if ! [[ "$BRANCH_NAME" =~ ^agent/(codex|claude|copilot|sparks)/[0-9]+-[a-z0-9-]+$ ]]; then
            ERRORS+=("‚ùå Invalid branch name format. Expected: agent/{agent_name}/{issue_number}-{slug}")
          fi
          
          # Check for required PR elements
          if ! echo "$PR_BODY" | grep -q "Agent Handoff Protocol"; then
            ERRORS+=("‚ùå Missing Agent Handoff Protocol section")
          fi
          
          if ! echo "$PR_BODY" | grep -q "@claude-code"; then
            ERRORS+=("‚ùå Missing @claude-code handoff mention")
          fi
          
          if ! echo "$PR_BODY" | grep -q "Closes #[0-9]"; then
            ERRORS+=("‚ùå Missing 'Closes #issue' reference")
          fi
          
          if ! echo "$PR_BODY" | grep -q "Review Checklist"; then
            ERRORS+=("‚ùå Missing Review Checklist")
          fi
          
          # Check for implementation file
          ISSUE_NUM=$(echo "$BRANCH_NAME" | grep -o '/[0-9]\+' | cut -d'/' -f2)
          if [ ! -f "IMPLEMENTATION_$ISSUE_NUM.md" ]; then
            ERRORS+=("‚ùå Missing implementation file: IMPLEMENTATION_$ISSUE_NUM.md")
          fi
          
          # Report results
          if [ ${#ERRORS[@]} -gt 0 ]; then
            echo "üö´ PR validation failed:"
            printf '%s\n' "${ERRORS[@]}"
            
            # Comment on PR with validation errors
            COMMENT="## üö´ Autonomous PR Validation Failed

This pull request was created by an autonomous agent but failed validation checks:

$(printf '%s\n' "${ERRORS[@]}")

### Required Actions
- Fix the validation errors above
- Ensure proper agent handoff protocol is followed
- Re-run the autonomous workflow if needed

### Sovereign Canon Requirements
- Branch name must follow: \`agent/{agent_name}/{issue_number}-{slug}\`
- PR body must include Agent Handoff Protocol section
- Must reference Claude for review: \`@claude-code\`
- Must include \`Closes #issue\` reference
- Must include Review Checklist
- Must include implementation documentation

ü§ñ Automated validation by Sovereign Autonomous System"
            
            gh pr comment "${{ github.event.pull_request.number }}" --body "$COMMENT"
            exit 1
          else
            echo "‚úÖ PR validation passed"
            
            # Add success comment and labels
            COMMENT="## ‚úÖ Autonomous PR Validation Passed

This pull request was created by an autonomous agent and has passed all validation checks.

### Validation Results
- ‚úÖ Branch naming convention followed
- ‚úÖ Agent handoff protocol included
- ‚úÖ Claude review requested
- ‚úÖ Issue reference included
- ‚úÖ Review checklist provided
- ‚úÖ Implementation documentation present

**Ready for Claude review and merge approval.**

ü§ñ Automated validation by Sovereign Autonomous System"
            
            gh pr comment "${{ github.event.pull_request.number }}" --body "$COMMENT"
            gh pr edit "${{ github.event.pull_request.number }}" --add-label "agent:validated"
          fi

      - name: Auto-assign Claude for review
        if: success()
        run: |
          # Add Claude as reviewer if available
          echo "üîî Requesting Claude review..."
          
          # Note: This would ideally assign @claude-code if it were a GitHub user
          # For now, we rely on the @claude-code mention in the PR body
          
          gh pr edit "${{ github.event.pull_request.number }}" --add-label "review:claude-required"
          
          echo "‚úÖ Claude review requested via label and mention"

  security-scan:
    if: startsWith(github.head_ref, 'agent/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Security scan for autonomous changes
        run: |
          echo "üîí Performing security scan on autonomous changes..."
          
          # Check for potential security issues in agent-generated code
          SECURITY_ISSUES=()
          
          # Scan for hardcoded secrets
          if git diff HEAD~1..HEAD | grep -iE "(password|secret|key|token)" | grep -v "GITHUB_TOKEN"; then
            SECURITY_ISSUES+=("‚ö†Ô∏è Potential hardcoded credentials detected")
          fi
          
          # Check for dangerous commands
          if git diff HEAD~1..HEAD | grep -E "(rm -rf|sudo|curl.*sh|eval|exec)"; then
            SECURITY_ISSUES+=("‚ö†Ô∏è Potentially dangerous commands detected")
          fi
          
          # Check for external network calls
          if git diff HEAD~1..HEAD | grep -E "(http://|https://)" | grep -v "github.com\|sovereign"; then
            SECURITY_ISSUES+=("‚ö†Ô∏è External network calls detected")
          fi
          
          # Report security scan results
          if [ ${#SECURITY_ISSUES[@]} -gt 0 ]; then
            echo "üö® Security issues detected:"
            printf '%s\n' "${SECURITY_ISSUES[@]}"
            
            COMMENT="## üö® Security Scan Alert

Security scan detected potential issues in this autonomous PR:

$(printf '%s\n' "${SECURITY_ISSUES[@]}")

### Required Actions
- Manual security review required before merge
- Verify all changes are legitimate and safe
- Remove any hardcoded credentials or dangerous operations

üîí Automated security scan by Sovereign Autonomous System"
            
            gh pr comment "${{ github.event.pull_request.number }}" --body "$COMMENT"
            gh pr edit "${{ github.event.pull_request.number }}" --add-label "security:review-required"
          else
            echo "‚úÖ Security scan passed"
            gh pr edit "${{ github.event.pull_request.number }}" --add-label "security:cleared"
          fi